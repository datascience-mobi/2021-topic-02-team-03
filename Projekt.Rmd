---
title: "The role of skin-specific genes in skin cancer"
author: "Denisa Neacsu, Binnur Özay, Christofer Richard, Pinar Cavus"
date: "4/28/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 0. Introduction

The goal of this project is to find the expression of skin specific genes in skin cancer datasets. As datasets, we used microarray data (Affymetrix chips).


## 1. TRA Analysis

The first line below is from my computer personally, your home user name and file names are probably different in your computer!

```{r}
projectPath=dirname(rstudioapi::getSourceEditorContext()$path)
projectPath

#Import TRA Data
setwd(paste(projectPath, 'TRA Daten', sep = '/'))
TRA_Human_gtex=read.csv(file="tra.2017.human.gtex.5x.table.tsv",sep="\t")
TRA_Mouse_4301=read.csv(file="tra.2014.mouse.4301.5x.table.tsv", sep="\t")
TRA_Human_roth=read.csv(file="tra.2014.human.roth.5x.table.tsv", sep="\t")
TRA_Human_Novartis=read.csv(file="tra.2014.human.5x.table.tsv", sep="\t")
TRA_Mouse_Novartis=read.csv(file="tra.2014.mouse.5x.table.tsv", sep="\t")
TRA_Human_protien_atlas=read.csv(file="Human_protein_atlas_TRA_5median_genes_annotated.tsv", sep=",")
```

```{r}
#Skin-specific genes from TRA_Human_Novartis
tissue1=TRA_Human_Novartis[,11]
ind1=which(tissue1=="skin")
TRA.symbol1=TRA_Human_Novartis$gene.symbol

skin.TRA1=TRA.symbol1[ind1]
skin.TRA1
```

```{r}
#Skin-specific genes from TRA_Human_protein_atlas
tissue2=TRA_Human_protien_atlas[,11]
ind2=which(tissue2=="skin")
TRA.symbol2=TRA_Human_protien_atlas$Symbol

skin.TRA2=TRA.symbol2[ind2]
skin.TRA2
```

#TRA_Human_gtex for skin sun exposed

```{r}
#Skin-specific genes from TRA_Human_gtex (sun exposed)
tissue3.s=TRA_Human_gtex[,10]
ind3.s=which(tissue3.s=="Skin - Sun Exposed")
TRA.symbol3.s=TRA_Human_gtex$ensembl.symbol

skin.TRA3.s=TRA.symbol3.s[ind3.s]
skin.TRA3.s
```

#TRA_Human_gtex for skin not sun exposed

```{r}
#Skin-specific genes from TRA_Human_gtex (not sun exposed)
tissue3.ns=TRA_Human_gtex[,10]
ind3.ns=which(tissue3.ns=="Skin - Not Sun Exposed")
TRA.symbol3.ns=TRA_Human_gtex$ensembl.symbol

skin.TRA3.ns=TRA.symbol3.ns[ind3.ns]
skin.TRA3.ns
```

#We got the output "character(0)" here, but that is because this table actually doesn't have any data for skin tissue in it.

```{r}
#Skin-specific genes from TRA_Human_roth (no skin-specific genes)
tissue4=TRA_Human_roth[,11]
ind4=which(tissue4=="skin")
TRA.symbol4=TRA_Human_roth$gene.symbol

skin.TRA4=TRA.symbol4[ind4]
skin.TRA4
```

#For the two mouse datasets we couldn't find any tissue named "skin", but we did find tissue named "epidermis". I'm guessing that is because the tables show results of mice and not humans, so the researchers decided to name the sublayer of the skin itself.

```{r}
#Skin-specific genes from TRA_Mouse_4301 (epidermis-specific genes)
tissue5=TRA_Mouse_4301[,11]
ind5=which(tissue5=="epidermis")
TRA.symbol5=TRA_Mouse_4301$gene.symbol

skin.TRA5=TRA.symbol5[ind5]
skin.TRA5
```

```{r}
#Skin-specific genes from TRA_Mouse_Novartis (epidermis-specific genes)
tissue6=TRA_Mouse_Novartis[,11]
ind6=which(tissue6=="epidermis")
TRA.symbol6=TRA_Mouse_Novartis$gene.symbol

skin.TRA6=TRA.symbol6[ind6]
skin.TRA6
```

#Vectors for all human skin- and mouse epidermis-specific genes

```{r}
#Creating vector with all the human skin genes
skin.genes.human = unique(c(skin.TRA1, skin.TRA2, skin.TRA3.ns, skin.TRA3.s))
skin.genes.human
length(skin.genes.human)

#Removing NAs
vector = lapply(skin.genes.human,function(x){sum(is.na(x))}) #sum up all missing values
vector
which(vector>0) # display the missing value
# no.239, that means 1 NA
skin.genes.human = skin.genes.human[-which(vector>0)] 
rm(vector)

length(skin.genes.human)
#646

which(is.na(skin.genes.human)) # Verification that the NA was removed


#Creating vector with all the mouse skin (epidermis) genes
skin.genes.mouse = c(skin.TRA5, skin.TRA6)
skin.genes.mouse
length(skin.genes.mouse)
```

#Creating .csv files for both human skin genes and mouse skin genes

```{r}
#The data is unfiltered, meaning no imputation of missing values was applied. We observed numerous NA in both human and mouse skin genes

#Putting the tables in a tables folder
setwd(paste(projectPath, 'tables', sep = '/')) #
#Using write.csv to create the files
write.csv(matrix(skin.genes.human), file = "skin.specific.genes.human.TRA", row.names = F, sep = "\t")
write.csv(matrix(skin.genes.mouse), file = "skin.specific.genes.mouse.TRA", row.names = F, sep = "\t")

#If write.cvs doesn't work for you you can try to use write.table. 
```

##2. Quality control of microarray data

#2.1 Analysis of skin cancer data set

```{r}
#Loading the necessary libraries
library(affy)
library(vsn)
library(AnnotationDbi)
library(hgu133plus2hsenstcdf)
library(hgu133plus2hsenstprobe)
library(hexbin)
library(stringr)

standardPath <- .libPaths()
standardPath
```

```{r}
#Setting directory for microarray data
setwd(paste(projectPath, 'rawdata/GSE57721 melanoma', sep = '/'))

#Read all 15 microarray chips
data.skin.cancer = ReadAffy()
data.skin.cancer@cdfName <- "HGU133Plus2_Hs_ENST"
data.skin.cancer

orig = colnames(exprs(data.skin.cancer))
new.name = substr(orig, 1, nchar(orig)-4)
colnames(exprs(data.skin.cancer)) = new.name

setwd(paste(projectPath, 'sessions/rda', sep = '/'))
save.image(file = "data.skin.cancer.rda")

```

#2.1.1. Single chip control

```{r}
#Visualizing raw microarray data
image(data.skin.cancer,col=rainbow(100,start = 0, end = 0.75) [100:1])

##All of the chips seem to have a very good quality, so we can use all of them
```


#3. Normalization of microarray data

```{r}
#Normalization is used to remove systematic variation that can affect the analysis of the chips
#Still in work

data.skin.cancer.norm = vsnrma(data.skin.cancer)
data.skin.cancer.norm

setwd(paste(projectPath, 'sessions/rda', sep = '/'))
save.image(file = "normalized_data.rda")
```

#4.1. meanSdPlot

```{r}
#Plotting meanSdPlot
meanSdPlot(data.skin.cancer.norm)

setwd(paste(projectPath, 'plots', sep = '/'))
dev.copy2eps(file = "meanSdPlot_data_skin_cancer_normalized.eps")
```



#4.3. Boxplots of pre-normalized and normalized data

```{r}
#Before normalization
  ## Install the newest version of XQuartz from https://www.xquartz.org/ in your computer
    ### We would recommend to have the XQuartz application open while running the code
x11(w=10, h=7)

par(las=2)
mmi = c(1.8, 0.7, 1.0477939, 0.5366749)
par(mai=mmi)

boxplot(data.skin.cancer, col=rainbow(150), cex.axis = 0.5, main = "Gene expression in skin cancer before normalization")

setwd(paste(projectPath, 'plots', sep = '/'))
dev.copy2eps(file = "boxplot_skin_cancer_rawdata.eps")


#After normalization
x11(w=10, h=7)

par(las=2)
mmi = c(1.8, 0.7, 1.0477939, 0.5366749)
par(mai=mmi)

boxplot(exprs(data.skin.cancer.norm), col=rainbow(150), cex.axis = 0.5, main = "Gene expression in skin cancer after normalization") #Here use exprs(), otherwise there will be an error "x must be atomic"

setwd(paste(projectPath, 'plots', sep = '/'))
dev.copy2eps(file = "boxplot_skin_cancer_normalized.eps")
```



#4.5. RNA degradation 
```{r}
rna_degradation = AffyRNAdeg(data.skin.cancer)

# RNA degradation plot shifted and scaled
plotAffyRNAdeg(rna_degradation, col = rainbow(150))
title(sub="Human skin cancer raw")
setwd(paste(projectPath, 'plots', sep = '/'))
dev.copy2eps(file = "RNA_degradation_data_skin_cancer_raw.eps")

#RNA degradation plot only shifted
plotAffyRNAdeg(rna_degradation, col = rainbow(150), transform = "shift.only")
title(sub = "Human skin cancer raw")

setwd(paste(projectPath, 'plots', sep = '/'))
dev.copy2eps(file= "RNA_deg_data_skin_cancer_raw.eps")

summaryAffyRNAdeg(rna_degradation) # According to the values of the slopes, which have similar values, it seems that all the chips should be considered in our analysis

## According to the plots, there is no obvious deviation, no line stands out; all of the chips have high expression intensity
## The chips are qualitative
```

#4.6. Histogram
```{r}
## Histogram before data normalization
x11(w=10, h=7)
hist(data.skin.cancer, col = rainbow(150), main = "Histogram data pre-normalized")
setwd(paste(projectPath, 'plots', sep = '/'))
dev.copy2eps(file = "Histogram data pre-normalized")

## Histogram after data normalization
for (i in 1:ncol(exprs(data.skin.cancer.norm))) if (i == 1) plot(density(log2(exprs(data.skin.cancer.norm)[, i])), col = "red") else lines(density(log2(exprs(data.skin.cancer.norm)[, i])), col = "red")

     
setwd(paste(projectPath, 'plots', sep = '/'))
dev.copy2eps(file = "Histogram data normalized.eps")
```

#4.7 Heatmap for the purpose of correlation visualization
```{r}
## Correlation matrix of the normalized data
cor.mat = cor(exprs(data.skin.cancer.norm), method="spearman")

## Heatmap 
library(pheatmap)
pheatmap(cor.mat)

setwd(paste(projectPath, 'plots', sep = '/'))
dev.copy2eps(file =  "Heatmap correlation chips.eps")
```

#4.2 Creating the gene expression data frame
```{r}
## extract expression values
Expression=exprs(data.skin.cancer.norm)
Expression
dim(Expression)
# 95721    15

## Select only ENST IDs, which represent the transcript IDs
enst_id = str_detect(rownames(Expression),"ENST")
Expression=Expression[enst_id,]
Expression
dim(Expression)
# 95659    15


## remove .x_at suffix by using \\..*, which basically means removing every character after the dot "."
rownames(Expression) = sub("\\..*","",rownames(Expression)) 
dim(Expression)
Expression

## Remove .CEL suffix from each column name
colnames(Expression) = sub("\\..*","", colnames(Expression))
Expression

## load ensemble IDs and gene symbols from https://www.ensembl.org/biomart/martview/74741c6cba3dea58c83e6520f12fa790
## Create the ensembl.103.txt file using BioMart
## Here beware of Transcript.stable.ID, Chromosome, AFFY HG U133 Plus 2 probe and HGNC symbol, as we need them to visualize the gene data frame

setwd(paste(projectPath, 'tables', sep = '/'))
Ensembl = read.csv(paste(projectPath, 'tables/ensembl.103.txt', sep = '/'), sep = "\t")
head(Ensembl)

## Extracting the transcript IDs and the HGNC symbols (or gene symbols) from the ensembl data frame
transcriptIDs = Ensembl$Transcript.stable.ID
HGNC_symbol = Ensembl$HGNC.symbol

## Assigning every gene symbol to a transcript ID
names(HGNC_symbol) = transcriptIDs
HGNC_symbol

## replace ensemble IDs with HGNC symbol
chipIDs = rownames(Expression)
noMatchIDs = chipIDs[!chipIDs %in% transcriptIDs] # transcript IDs that are not in ensemble.103.txt
length(noMatchIDs)
# 112 
newChipIDs = chipIDs[chipIDs %in% transcriptIDs] # only transcript IDs that are in ensemble.103.txt (95659 - 112 = 95547)
Expression = Expression[newChipIDs, ]
dim(Expression)
# 95547    15

symbol = HGNC_symbol[newChipIDs]
rownames(Expression) = as.character(symbol)
head(Expression)



### Cleaning the Expression data frame

## Checking for NAs
length(which(is.na(Expression)))
# 0 

## Checking for ""
length(which(rownames(Expression)==""))
#1096

## Removing "" (spaces)
all.spaces.exp = sapply(rownames(Expression),function(x){which(x=="")}) #sum up all spaces ""

which(all.spaces.exp>0) # display the spaces ""

Expression = Expression[-which(all.spaces.exp>0),] 
rm(all.spaces.exp)
dim(Expression)
#94451 15
```

#4.4. Skin-specific antigens extraction from gene expression df
##Checking to see how much skin specific TRAs are expressed in the melanoma data set
```{r}
skin.genes.human.expression = which(rownames(Expression)%in%skin.genes.human)
data.skin.cancer.human_skin_TRA = Expression[skin.genes.human.expression,]
y = sort(rownames(data.skin.cancer.human_skin_TRA))
unique(y[y !=""])
data.skin.cancer.human_skin_TRA = data.skin.cancer.human_skin_TRA[unique(y[y !=""]),]
dim(data.skin.cancer.human_skin_TRA)
#512  15
head(data.skin.cancer.human_skin_TRA)


## Changing column names in data.skin.cancer.human_skin_TRA data frame

colnames(data.skin.cancer.human_skin_TRA)[1] = "Sherk1_D3a"
colnames(data.skin.cancer.human_skin_TRA)[2] = "Sherk1_D3b"
colnames(data.skin.cancer.human_skin_TRA)[3] = "Sherk1_D3c"
colnames(data.skin.cancer.human_skin_TRA)[4] = "Sherk1_D7a"
colnames(data.skin.cancer.human_skin_TRA)[5] = "Sherk1_D7c"
colnames(data.skin.cancer.human_skin_TRA)[6] = "ERK12_inh_3ha"
colnames(data.skin.cancer.human_skin_TRA)[7] = "ERK12_inh_3hb"
colnames(data.skin.cancer.human_skin_TRA)[8] = "Trametinib_3hb"
colnames(data.skin.cancer.human_skin_TRA)[9] = "Trametinib_3hc"
colnames(data.skin.cancer.human_skin_TRA)[10] = "ERK12_inh_24ha"
colnames(data.skin.cancer.human_skin_TRA)[11] = "ERK12_inh_24hb"
colnames(data.skin.cancer.human_skin_TRA)[12] = "ERK12_inh_24hc"
colnames(data.skin.cancer.human_skin_TRA)[13] = "Trametinib_24ha"
colnames(data.skin.cancer.human_skin_TRA)[14] = "Trametinib_24hb"
colnames(data.skin.cancer.human_skin_TRA)[15] = "Trametinib_24hc"

head(data.skin.cancer.human_skin_TRA)
```

#5. Analysis

```{r}
#Heatmap (Visualization)
install.packages("gplots")
library(gplots)

heatmap.2(data.skin.cancer.human_skin_TRA, key = T, col = redgreen(100), symkey = F, symm = F,symbreaks = T, scale = "row", density.info = "none", trace = "none", cexRow = 0.6, cexCol = 0.6)
setwd(paste(projectPath, 'plots', sep = '/'))
dev.copy2eps(file = 'Heatmap for skin specific TRAs in skin cancer_1.eps') #eps file
dev.copy2pdf(file = 'Heatmap for skin specific TRAs in skin cancer_1.pdf') #pdf file
```

```{r}
#Barplot (Localisation in chromosomes)
##Get all the chromosome numbers for all human skin TRAs
chromosome_1 = TRA_Human_Novartis[,c(3,7)]
chromosome_skin1 = as.matrix(chromosome_1[ind1,])

chromosome_2 = TRA_Human_protien_atlas[,c(6,2)]
chromosome_skin2 = as.matrix(chromosome_2[ind2,])

chromosome_3 = TRA_Human_gtex[,c(3,6)]
chromosome_skin3 = as.matrix(chromosome_3[c(ind3.s, ind3.ns),])

##Combine all 3 tables and remove duplicates and empty values to make a clean list of chromosome numbers
chromosome_gene_table = rbind(chromosome_skin1, chromosome_skin2, chromosome_skin3)
rownames(chromosome_gene_table) = c()
head(chromosome_gene_table)

a = sort(chromosome_gene_table[,1])

rownames(chromosome_gene_table) = chromosome_gene_table[,1]
chromosome_gene_table = chromosome_gene_table[,2]

chromosome_list = chromosome_gene_table[unique(a[a !=""])]

##Count the number of genes on each chromosome
localization = table(chromosome_list)
localization = as.matrix(localization)

sorted_chromosomes = str_sort(rownames(localization), numeric = T)
chromosome_counts = localization[sorted_chromosomes,]

##Make barplot
chromosome = c(1:22, "X")

barplot(chromosome_counts, main = "Distribution of skin-specific TRAs over chromosomes", xlab = "Chromosomes", ylab = "Number of skin-specific TRAs", names.arg = chromosome, cex.names = 0.7, col = "darkred")

setwd(paste(projectPath, 'plots', sep = '/'))
dev.copy2eps(file = 'Distribution of skin-specific TRAs over chromosomes.eps') # eps file
dev.copy2pdf(file = 'Distribution of skin-specific TRAs over chromosomes.pdf') # pdf file
```

```{r}
#Piechart (skin TRAs)

#Creating small vectors for each table containing only NON-skin-specific TRAs
#TRA_Human_Novartis
bla1 = which(tissue1!="skin")
TRA.symbolA=TRA_Human_Novartis$gene.symbol
non.skin.TRA1=TRA.symbolA[bla1]
non.skin.TRA1

#TRA_Human_protein_atlas
bla2 = which(tissue2!="skin")
TRA.symbolB=TRA_Human_protien_atlas$Symbol
non.skin.TRA2=TRA.symbolB[bla2]
non.skin.TRA2

#TRA_Human_gtex (sun exposed)
bla3.s = which(tissue3.s!="skin")
TRA.symbolC=TRA_Human_gtex$ensembl.symbol
non.skin.TRA3.s=TRA.symbolC[bla3.s]
non.skin.TRA3.s

#TRA_Human_gtex (not sun exposed)
bla3.ns = which(tissue3.ns!="skin")
TRA.symbolD=TRA_Human_gtex$ensembl.symbol
non.skin.TRA3.ns=TRA.symbol3.ns[bla3.ns]
non.skin.TRA3.ns


# Putting all the small non-skin-specific TRA vectors in a general vector containing all of them
NON_skin_specific_TRA = unique(c(non.skin.TRA1, non.skin.TRA2, non.skin.TRA3.s, non.skin.TRA3.ns))
length(NON_skin_specific_TRA)

# Calculating the total number of TRA
total = length(skin.genes.human) + length(NON_skin_specific_TRA)
total
prozent = round(length(skin.genes.human)/total*100,2)
prozent 
prozent_2 = round(length(NON_skin_specific_TRA)/total*100,2)
prozent_2
labels = c("Skin-specific TRAs", "Other TRAs")
labels = paste(labels, c(prozent, prozent_2)) # add percents to labels
labels = paste(labels,"%",sep="") # ad % to labels

# install.packages("RColorBrewer")
library(RColorBrewer)

color = brewer.pal(length(labels), "Spectral") 

pie( c(prozent, prozent_2),labels = labels, col = color,
   main="Pie Chart skin specific TRAs")
legend("topright", labels, cex = 0.8,fill = color)

setwd(paste(projectPath, 'plots', sep = '/'))


dev.copy2eps(file="Piechart_skin_TRA.eps") # eps file
dev.copy2pdf(file="Piechart_skin_TRA.pdf") # pdf file
```

# Highly expressed genes (does not mean upregulated)

```{r}
# This is what our genes' expressions look like
par(las=2)
boxplot(t(data.skin.cancer.human_skin_TRA),col=rainbow(length(rownames(data.skin.cancer.human_skin_TRA))),main="Expression of all skin genes in melanoma",cex.axis=0.8)


# Putting the highly expressed genes in a vector
data = data.skin.cancer.human_skin_TRA

highgenes = c()
for (i in length(colnames(data))) {
  highgenes = c(highgenes, names(which(data[,i] > 12)))
}
highgenes = unique(highgenes)

high = data[highgenes,]


# looking at the expressions of the highly expressed genes
par(las=2)
boxplot(t(high),col=rainbow(length(rownames(high))),main="Highly expressed skin genes in melanoma",cex.axis=0.8)

# I have noted the expressions of these for every chip, and they vary except for two highest: GPNMB and ANXA2
# except for these two NDRG1, RPL18, DCT, CD44, MLANA also showed high expressions, although varying between chips, the decision of if we're going to involve these too or not would only make sense after comparing the expression data of these genes over all the chips at the same time
```


# Log fold change and t-test

```{r}
# logFC : Finding the most upregulated genes from each treatment
## Average the gene expression for each treatment at each time point
sherk_3d = apply(data.skin.cancer.human_skin_TRA[,1:3], 1, mean)
sherk_7d = apply(data.skin.cancer.human_skin_TRA[,4:5], 1, mean)
erk12_3h = apply(data.skin.cancer.human_skin_TRA[,6:7], 1, mean)
erk12_24h = apply(data.skin.cancer.human_skin_TRA[,10:12], 1, mean)
trametinib_3h = apply(data.skin.cancer.human_skin_TRA[,8:9], 1, mean)
trametinib_24h = apply(data.skin.cancer.human_skin_TRA[,13:15], 1, mean)

## Calculate the log fold change for each gene from each treatment
logFC_sherk = sort(sherk_7d - sherk_3d, decreasing = T)
logFC_erk12 = sort(erk12_24h - erk12_3h, decreasing = T)
logFC_trametinib =  sort(trametinib_24h - trametinib_3h, decreasing = T)

## Top 10 logFC from each treatment
logFC_sherk_top = logFC_sherk[1:11]
logFC_erk12_top = logFC_erk12[1:10]
logFC_trametinib_top = logFC_trametinib[1:10]



# T-test : Filtering upregulated genes that are significant
## Checking significance for genes in the top 10 logFC of Sherk
t_sherk = function(x) {
  t.test(data.skin.cancer.human_skin_TRA[x, 1:3], data.skin.cancer.human_skin_TRA[x, 4:5])$p.value
}
t_test_sherk = sort(sapply(names(logFC_sherk), t_sherk), decreasing = F)
t_test_sherk_significant = t_test_sherk[which(t_test_sherk < 0.05)]

upreg_sherk_significant = names(logFC_sherk_top)[names(logFC_sherk_top) %in% names(t_test_sherk_significant)]
upreg_sherk_significant


## Checking significance for genes in the top 10 logFC of ERK1/2 inhibitor
t_erk12 = function(x) {
  t.test(data.skin.cancer.human_skin_TRA[x, 6:7], data.skin.cancer.human_skin_TRA[x, 10:12])$p.value
}
t_test_erk12 = sort(sapply(names(logFC_erk12), t_erk12), decreasing = F)
t_test_erk12_significant = t_test_erk12[which(t_test_erk12 < 0.05)]

upreg_erk12_significant = names(logFC_erk12_top)[names(logFC_erk12_top) %in% names(t_test_erk12_significant)]
upreg_erk12_significant


## Checking significance for genes in the top 10 logFC of trametinib
t_trametinib = function(x) {
  t.test(data.skin.cancer.human_skin_TRA[x, 8:9], data.skin.cancer.human_skin_TRA[x, 13:15])$p.value
}
t_test_trametinib = sort(sapply(names(logFC_trametinib), t_trametinib), decreasing = F)
t_test_trametinib_significant = t_test_trametinib[which(t_test_trametinib < 0.05)]

upreg_trametinib_significant = names(logFC_trametinib_top)[names(logFC_trametinib_top) %in% names(t_test_trametinib_significant)]
upreg_trametinib_significant
```

# Boxplots for different treatments on different times for upregulated genes

```{r}
#Sherk
data_sherk_upreg = data.skin.cancer.human_skin_TRA[upreg_sherk_significant, c(1:5)]
data.new_sherk = rbind(data_sherk_upreg, data_sherk_upreg)
data.new_sherk[c(1:2), c(4:5)] = NA
data.new_sherk[c(3:4), c(1:3)] = NA

order.vector = sort(colnames(t(data.new_sherk)),index.return=T)$ix
boxplot(t(data.new_sherk)[,order.vector], cex.axis = 0.6, col = c("blue", "pink"), main = "Upregulated genes in treatment with Sherk", ylab = "log2(gene expression)", xlab = "Upregulated genes", las = 2)
abline(h = c(6:12), col = "grey", lty = 3)
legend("topleft", c("Sherk1 after 3 days", "Sherk1 after 7 days"), col = c("blue", "pink"), pch = 15, bg = "white")


#ERK1/2 inhibitor
data_erk12_upreg = data.skin.cancer.human_skin_TRA[upreg_erk12_significant, c(6:7, 10:12)]
data.new_erk12 = rbind(data_erk12_upreg, data_erk12_upreg)
data.new_erk12[c(1:8), c(3:5)] = NA
data.new_erk12[c(9:16), c(1:2)] = NA

order.vector = sort(colnames(t(data.new_erk12)),index.return=T)$ix
boxplot(t(data.new_erk12)[,order.vector], cex.axis = 0.6, col = c("blue", "pink"), main = "Upregulated genes in treatment with ERK1/2 inhibitor", ylab = "log2(gene expression)", xlab = "Upregulated genes", las = 2)
abline(h = c(6:14), col = "grey", lty = 3)
legend("topleft",c("ERK1/2 inhibitor after 3h", "ERK1/2 inhibitor after 24h"), col = c("blue", "pink"), pch = 15, bg = "white")


#Trametinib
data_trametinib_upreg = data.skin.cancer.human_skin_TRA[upreg_trametinib_significant, c(8:9, 13:15)]
data.new_trametinib = rbind(data_trametinib_upreg, data_trametinib_upreg)
data.new_trametinib[c(1:8), c(3:5)] = NA
data.new_trametinib[c(9:16), c(1:2)] = NA

order.vector = sort(colnames(t(data.new_trametinib)),index.return=T)$ix
boxplot(t(data.new_trametinib)[,order.vector], cex.axis = 0.6, col = c("blue", "pink"), main = "Upregulated genes in treatment with Trametinib", ylab = "log2(gene expression)", xlab = "Upregulated genes", las = 2)
abline(h = c(6:14), col = "grey", lty = 3)
legend("left",c("Trametinib after 3h", "Trametinib after 24h"),col=c("blue", "pink"), pch = 15, bg = "white")
```


# Downregulated genes
```{r}
###Look into genes that are downregulated. It would mean that the drug has worked on genes that were tumour inducing at the beginning

## Last 10 logFC from each treatment

logFC_sherk_down_regulated = logFC_sherk[503:512]
logFC_erk12_down_regulated = logFC_erk12[503:512]
logFC_trametinib_down_regulated = logFC_trametinib[503:512]


# T-test : Filtering downregulated genes that are significant
## Checking significance for genes in the last 10 logFC of Sherk
t_sherk = function(x) {
  t.test(data.skin.cancer.human_skin_TRA[x, 1:3], data.skin.cancer.human_skin_TRA[x, 4:5])$p.value
}
t_test_sherk = sort(sapply(names(logFC_sherk), t_sherk), decreasing = F)
t_test_sherk_significant = t_test_sherk[which(t_test_sherk < 0.05)]

downreg_sherk_significant = names(logFC_sherk_down_regulated)[names(logFC_sherk_down_regulated) %in% names(t_test_sherk_significant)]
downreg_sherk_significant # TYRP1 is downregulated on the shERK treatment (doxycycline inducible shRNA), but upregulated on ERK12 Inhibitor and Trametinib. TYRP1 has been associated with a poor prognosis for melanoma (Journe, F., Boufker, H., Van Kempen, L. et al. TYRP1 mRNA expression in melanoma metastases correlates with clinical outcome. Br J Cancer 105, 1726–1732 (2011). https://doi.org/10.1038/bjc.2011.451). 



## Checking significance for genes in the last 10 logFC of ERK1/2 inhibitor
t_erk12 = function(x) {
  t.test(data.skin.cancer.human_skin_TRA[x, 6:7], data.skin.cancer.human_skin_TRA[x, 10:12])$p.value
}
t_test_erk12 = sort(sapply(names(logFC_erk12), t_erk12), decreasing = F)
t_test_erk12_significant = t_test_erk12[which(t_test_erk12 < 0.05)]

downreg_erk12_significant = names(logFC_erk12_down_regulated)[names(logFC_erk12_down_regulated) %in% names(t_test_erk12_significant)]
downreg_erk12_significant


## Checking significance for genes in the last 10 logFC of trametinib
t_trametinib = function(x) {
  t.test(data.skin.cancer.human_skin_TRA[x, 8:9], data.skin.cancer.human_skin_TRA[x, 13:15])$p.value
}
t_test_trametinib = sort(sapply(names(logFC_trametinib), t_trametinib), decreasing = F)
t_test_trametinib_significant = t_test_trametinib[which(t_test_trametinib < 0.05)]

downreg_trametinib_significant = names(logFC_trametinib_down_regulated)[names(logFC_trametinib_down_regulated) %in% names(t_test_trametinib_significant)]
downreg_trametinib_significant

```


# Boxplots for different treatments on different times for the downregulated genes

```{r}
#Sherk
data_sherk_downreg = data.skin.cancer.human_skin_TRA[downreg_sherk_significant, c(1:5)]
data.new_sherk_downreg = rbind(data_sherk_downreg, data_sherk_downreg)
data.new_sherk_downreg[c(1:2), c(4:5)] = NA
data.new_sherk_downreg[c(3:4), c(1:3)] = NA

order.vector = sort(colnames(t(data.new_sherk_downreg)),index.return=T)$ix
boxplot(t(data.new_sherk_downreg)[,order.vector], cex.axis = 0.6, col = c("blue", "pink"), main = "Downregulated genes in treatment with Sherk", ylab = "log2(gene expression)", xlab = "Downregulated genes", las = 2)
abline(h = c(6:12), col = "grey", lty = 3)
legend("topleft", c("Sherk1 after 3 days", "Sherk1 after 7 days"), col = c("blue", "pink"), pch = 15, bg = "white")


#ERK1/2 inhibitor
data_erk12_downreg = data.skin.cancer.human_skin_TRA[downreg_erk12_significant, c(6:7, 10:12)]
data.new_erk12_downreg = rbind(data_erk12_downreg, data_erk12_downreg)
data.new_erk12_downreg[c(1:8), c(3:5)] = NA
data.new_erk12_downreg[c(9:16), c(1:2)] = NA

order.vector = sort(colnames(t(data.new_erk12_downreg)),index.return=T)$ix
boxplot(t(data.new_erk12_downreg)[,order.vector], cex.axis = 0.6, col = c("blue", "pink"), main = "Downregulated genes in treatment with ERK1/2 inhibitor", ylab = "log2(gene expression)", xlab = "Downregulated genes", las = 2)
abline(h = c(6:14), col = "grey", lty = 3)
legend("topleft",c("ERK1/2 inhibitor after 3h", "ERK1/2 inhibitor after 24h"), col = c("blue", "pink"), pch = 15, bg = "white")


#Trametinib
data_trametinib_downreg = data.skin.cancer.human_skin_TRA[downreg_trametinib_significant, c(8:9, 13:15)]
data.new_trametinib_downreg = rbind(data_trametinib_downreg, data_trametinib_downreg)
data.new_trametinib_downreg[c(1:8), c(3:5)] = NA
data.new_trametinib_downreg[c(9:16), c(1:2)] = NA

order.vector = sort(colnames(t(data.new_trametinib_downreg)),index.return=T)$ix
boxplot(t(data.new_trametinib_downreg)[,order.vector], cex.axis = 0.6, col = c("blue", "pink"), main = "Downregulated genes in treatment with Trametinib", ylab = "log2(gene expression)", xlab = "Downregulated genes", las = 2)
abline(h = c(6:14), col = "grey", lty = 3)
legend("topleft",c("Trametinib after 3h", "Trametinib after 24h"),col=c("blue", "pink"), pch = 15, bg = "white")
```


#Venn diagram

```{r}
#Finding upregulated genes in skin cancer by logFC
## Average the gene expression for each treatment at each time point
sherk_3d_all = apply(Expression[,1:3], 1, mean)
sherk_7d_all = apply(Expression[,4:5], 1, mean)
erk12_3h_all = apply(Expression[,6:7], 1, mean)
erk12_24h_all = apply(Expression[,10:12], 1, mean)
trametinib_3h_all = apply(Expression[,8:9], 1, mean)
trametinib_24h_all = apply(Expression[,13:15], 1, mean)

## Calculate the log fold change for each gene from each treatment
logFC_sherk_all = sherk_7d_all - sherk_3d_all
logFC_erk12_all = erk12_24h_all - erk12_3h_all
logFC_trametinib_all =  trametinib_24h_all - trametinib_3h_all

## Only positive logFC from each treatment (only upregulated genes!)
logFC_sherk_pos = which(logFC_sherk_all > 0)
logFC_erk12_pos = which(logFC_erk12_all > 0)
logFC_trametinib_pos = which(logFC_trametinib_all > 0)

upreg_all = unique(c(names(logFC_sherk_pos), names(logFC_erk12_pos), names(logFC_trametinib_pos)))


# T-test to filter significantly upregulated genes
## Checking significance for Sherk
t_sherk_all = function(x) {
  if (Expression[x,1] == Expression[x,2] | Expression[x,1] == Expression[x,3] | Expression[x,3] == Expression[x,2] | Expression[x,4] == Expression[x,5])
    return(0.5)
  else
  t.test(Expression[x, 1:3], Expression[x, 4:5])$p.value
}
t_test_sherk_all = sapply(names(logFC_sherk_all), t_sherk_all)
t_test_sherk_significant_all = t_test_sherk_all[which(t_test_sherk_all < 0.05)]

upreg_sherk_significant_all = names(logFC_sherk_pos)[names(logFC_sherk_pos) %in% names(t_test_sherk_significant_all)]
upreg_sherk_significant_all

## Checking significance for ERK1/2 inhibitor
t_erk12_all = function(x) {
  t.test(Expression[x, 6:7], Expression[x, 10:12])$p.value
}
t_test_erk12_all = sapply(names(logFC_erk12_all), t_erk12_all)
t_test_erk12_significant_all = t_test_erk12_all[which(t_test_erk12_all < 0.05)]

upreg_erk12_significant_all = names(logFC_erk12_pos)[names(logFC_erk12_pos) %in% names(t_test_erk12_significant_all)]
upreg_erk12_significant_all

## Checking significance for Trametinib
t_trametinib_all = function(x) {
  t.test(Expression[x, 8:9], Expression[x, 13:15])$p.value
}
t_test_trametinib_all = sapply(names(logFC_trametinib_all), t_trametinib_all)
t_test_trametinib_significant_all = t_test_trametinib_all[which(t_test_trametinib_all < 0.05)]

upreg_trametinib_significant_all = names(logFC_trametinib_pos)[names(logFC_trametinib_pos) %in% names(t_test_trametinib_significant_all)]
upreg_trametinib_significant_all



#Venn diagram (Upregulated genes that are also TRAs)
install.packages("venn")
library(venn)
library(ggplot2)
library(ggpolypath)

list_venn = list(A = unique(c(upreg_sherk_significant_all, upreg_erk12_significant_all, upreg_trametinib_significant_all)), B = skin.genes.human)
names(list_venn) = c("Upregulated genes" , "TRA")

venn(list_venn, box = F, ilab = T, zcolor = c("#0073C2FF", "#EFC000FF"), cex = 1000)
text(500, 900, "Potential drug targets", cex = 2)

#Save the venn diagramm in a pdf file
setwd(paste(projectPath, 'plots', sep = '/'))
pdf("Venn_diagramm_trial.pdf")
venn(list_venn, box = F, ilab = T, zcolor = c("#0073C2FF", "#EFC000FF"))
text(500, 900, "Potential drug targets", cex = 2)
dev.off()
```


# Sun exposure

```{r}
# Boxplots of sun exposure vs no sun exposure in all data

# Finding the sun exposed and sun not exposed genes in our expression dataset
sun = intersect(rownames(data.skin.cancer.human_skin_TRA), skin.TRA3.s)
no.sun = intersect(rownames(data.skin.cancer.human_skin_TRA), skin.TRA3.ns)

# Removing the gene names to make a box plot of each chip
sun_exp = data.skin.cancer.human_skin_TRA[sun,]
nosun_exp = data.skin.cancer.human_skin_TRA[no.sun,]

sunexpchip = unname(sun_exp[,13])
nosunexpchip = unname(nosun_exp[,13])

lmts <- range(sunexpchip,nosunexpchip)

par(mfrow = c(1, 2))
for (i in 1:15) {
  boxplot(unname(sun_exp[,i]), ylim=lmts, main= "Sun exposure")
  boxplot(unname(nosun_exp[,i]), ylim=lmts, main= "No sun exposure")
}
## They don't seem to differ significantly, and the trend is similar for all of the chips.


# Comparing their significance with a Wilcoxon test for each chip
wilcox.test(sunexpchip, nosunexpchip)$p.value

wilcox_sun = function(x) {
  wilcox.test(data[sun, x], data[no.sun, x])$p.value
}

sapply(1:15, wilcox_sun)
## All of them have a p value of smaller than 0.05, proving a significant difference between the expression of sun or no sun exposure genes. So now we will compare the expression of genes that are expressed with or without sun exposure.

# Genes that are expressed with or without sun exposure
both.sun = intersect(sun, no.sun)
both.sun
# Genes that are only sun exposure related
only_sun = sun[!sun%in%both.sun]
only_sun

# Sun exposure related genes: search for the most significant genes for each treatment. From this result, it is suggested that ETV7, a transcription factor, is involved in the immunity of the tumor microenvironment, in which it stimulated cytokine intrusion in the tumor. ETV7 is normally dowregulated in melanoma patients, which is correlated with poor prognosis (Qu H, Zhao H, Zhang X, et al. Integrated Analysis of the ETS Family in Melanoma Reveals a Regulatory Role of ETV7 in the Immune Microenvironment. Front Immunol. 2020;11:612784. Published 2020 Dec 23. doi:10.3389/fimmu.2020.612784). Although in our case, ETV7 is upregulated on treatment with trametinib, suggesting that the treatment stimulates ETV7 expression and could have a significant role in the immunity of the tumor microenvironment.
#TGFB1 has also been strongly correlated with tumour proliferation in melanoma "there is ample evidence indicating that TGF-β is a potent pro-tumorigenic agent, acting via autocrine and paracrine mechanisms to promote peri-tumoral angiogenesis, together with tumor cell migration, immune escape, and dissemination to metastatic sites." (Perrot CY, Javelaud D, Mauviel A. Insights into the Transforming Growth Factor-β Signaling Pathway in Cutaneous Melanoma. Ann Dermatol. 2013;25(2):135-144. doi:10.5021/ad.2013.25.2.135)



# The visualization of these genes can be seen in the graphs showing the logFC for all significantly upregulated genes.
significat_sun_1 = upreg_sherk_significant[upreg_sherk_significant%in%only_sun]
significant_sun_2 = upreg_erk12_significant[upreg_erk12_significant%in%only_sun]
significant_sun_3 = upreg_trametinib_significant[upreg_trametinib_significant%in%only_sun]




```



# Clustering

# from Richard
```{r}
#Clustering of the chips
##k-means
km = kmeans(x = t(data_topVar), centers = 4, nstart = 15)
km$cluster

##Elbow method
###Picking the most variable genes
topVar = apply(data.skin.cancer.human_skin_TRA, 1, var)
data_topVar = data.skin.cancer.human_skin_TRA[topVar > quantile(topVar, probs = 0.8),]

###Plot graph for WSS
wss = sapply(2:10, function(k){kmeans(x = t(data_topVar), centers = k)$tot.withinss})
plot(2:10, wss, type = 'b', pch = 19, xlab = "Number of clusters", ylab ="WSS")
##Optimal number of clusters = 3 or 4 (more to 3(~70%), but sometimes also 4)

##Silhouette method
###Computing the pairwise distances of all patients
paired_d = dist(t(data_topVar))

###Plot graph
library(cluster)
plot(silhouette(km$cluster, paired_d))

####3 Clusters: 1) sherk D3 & D7    2)erk & trametinib 3h   3)erk & trametinib 24h

#Clustering of the upregulated genes?

```

# from Binnur

#Packages Used for Clustering

```{r}
library(factoextra)
library(clustertend)
library(fpc)
library(cluster)
library(clValid)
library(NbClust)
```

#Clustering of Sun Data

```{r}


sun = intersect(rownames(data.skin.cancer.human_skin_TRA), skin.TRA3.s)
no.sun = intersect(rownames(data.skin.cancer.human_skin_TRA), skin.TRA3.ns)
sun_exp = data.skin.cancer.human_skin_TRA[sun,]
nosun_exp = data.skin.cancer.human_skin_TRA[no.sun,]
sunexpchip = unname(sun_exp[,13])
nosunexpchip = unname(nosun_exp[,13])

bothexp = intersect(sun_exp, nosun_exp)
onlysun_exp = sun_exp[!(rownames(sun_exp)%in%rownames(bothexp)),]
onlysun_exp

both = rbind.data.frame(onlysun_exp, nosun_exp)
both = scale(both)

#Deciding on the number of clusters
set.seed(123)
##Elbow Method:
fviz_nbclust(both, kmeans, method = "wss")+labs(subtitle = "Elbow method")
##Silhouette Method:
fviz_nbclust(both, kmeans, method = "silhouette")+labs(subtitle = "Silhouette method")
##Gap stat method
gap_stat.both = clusGap(both, FUN = kmeans, nstart = 25, K.max = 10)
print(gap_stat.sun, method = "firstmax")
fviz_gap_stat(gap_stat.both)
##NbClust
nb.both = NbClust(both, distance = "euclidean",
              min.nc = 2,max.nc = 10, method = "kmeans")
fviz_nbclust(nb.both)


#Is the data really clusterable? H should be close to zero when yes.
hopkins(both, n = nrow(both)-1)
##H = 0.06742255
#Cluster Validation: Silhouette Information
km.both = eclust(both, "kmeans", k = 2, nstart = 25, graph = FALSE)
fviz_silhouette(km.both, palette = "jco",
ggtheme = theme_classic())
silboth = km.both$silinfo
names(silboth)
#Average silhouette width of each cluster, should be higher than 0.5
silboth$clus.avg.widths
#Mean of all individual silhouette widths)
silboth$avg.width

#Hierarchical Clustering
fviz_dend(hclust(dist(both)), k = 2, k_colors = c("orange", "blue"),
as.ggplot = TRUE, show_labels = FALSE)
#k-means Clustering
fviz_cluster(km.both, data = both, palette = c("orange", "blue"), geom = "point", ellipse.type = "convex", ggtheme = theme_bw())


```

# Clustering of the Up/Downregulated Data

```{r}

#Gathering the exp of upregulated genes
VANGL2_exp = data.skin.cancer.human_skin_TRA["VANGL2",]
TRPM1_exp = data.skin.cancer.human_skin_TRA["TRPM1",]
ETV7_exp = data.skin.cancer.human_skin_TRA["ETV7",]
DAPL1_exp = data.skin.cancer.human_skin_TRA["DAPL1",]
EFS_exp = data.skin.cancer.human_skin_TRA["EFS",]
DCT_exp = data.skin.cancer.human_skin_TRA["DCT",]
TYRP1_exp = data.skin.cancer.human_skin_TRA["TYRP1",]
upreg_trametinib_significant_exp = data.frame(VANGL2_exp,TRPM1_exp,ETV7_exp,DAPL1_exp,EFS_exp,DCT_exp,TYRP1_exp)
upreg_trametinib_significant_exp = t(upreg_trametinib_significant_exp)

MPZL3_exp = data.skin.cancer.human_skin_TRA["MPZL3",]
BCL11A_exp = data.skin.cancer.human_skin_TRA["BCL11A",]
upreg_sherk_significant_exp = t(data.frame(MPZL3_exp,BCL11A_exp))

ARHGEF5_exp = data.skin.cancer.human_skin_TRA["ARHGEF5",]
TRPM1_exp = data.skin.cancer.human_skin_TRA["TRPM1",]
ETV7_exp = data.skin.cancer.human_skin_TRA["ETV7",]
AACS_exp = data.skin.cancer.human_skin_TRA["AACS",]
EFS_exp = data.skin.cancer.human_skin_TRA["EFS",]
PPFIBP2_exp = data.skin.cancer.human_skin_TRA["PPFIBP2",]
TYRP1_exp = data.skin.cancer.human_skin_TRA["TYRP1",]
TGFBI_exp = data.skin.cancer.human_skin_TRA["TGFBI",]

upreg_erk12_significant_exp = t(data.frame(ARHGEF5_exp,TRPM1_exp,ETV7_exp,AACS_exp,EFS_exp,PPFIBP2_exp,TYRP1_exp, TGFBI_exp))

upregulated_all_exp = rbind.data.frame(upreg_erk12_significant_exp, upreg_sherk_significant_exp, upreg_trametinib_significant_exp)
upregulated_all_exp = distinct(upregulated_all_exp)
upregulated_all_exp

#Gathering the exp of downregulated genes
MMP2_exp = data.skin.cancer.human_skin_TRA["MMP2",]
TYRP1_downexp = data.skin.cancer.human_skin_TRA["TYRP1",]
downreg_sherk_significant_exp = t(data.frame(MMP2_exp,TYRP1_downexp))

CA12_exp = data.skin.cancer.human_skin_TRA["CA12",]
C3orf52_exp = data.skin.cancer.human_skin_TRA["C3orf52",]
CMSS1_exp = data.skin.cancer.human_skin_TRA["CMSS1",]
KRT27_exp = data.skin.cancer.human_skin_TRA["KRT27",]
CHTF18_exp = data.skin.cancer.human_skin_TRA["CHTF18",]
MPP4_exp = data.skin.cancer.human_skin_TRA["MPP4",]
POLA1_exp = data.skin.cancer.human_skin_TRA["POLA1",]
WEE1_exp = data.skin.cancer.human_skin_TRA["WEE1",]
REEP4_exp = data.skin.cancer.human_skin_TRA["REEP4",]
MFSD2A_exp = data.skin.cancer.human_skin_TRA["MFSD2A",]
downreg_erk12_significant_exp = t(data.frame(CA12_exp,C3orf52_exp,CMSS1_exp,KRT27_exp,CHTF18_exp,MPP4_exp,POLA1_exp,WEE1_exp,REEP4_exp,MFSD2A_exp))

RHNO1_exp = data.skin.cancer.human_skin_TRA["RHNO1",]
C3orf52_exp = data.skin.cancer.human_skin_TRA["C3orf52",]
CA12_exp = data.skin.cancer.human_skin_TRA["CA12",]
downreg_trametinib_significant_exp = t(data.frame(RHNO1_exp,C3orf52_exp,CA12_exp))

downregulated_all_exp = distinct(rbind.data.frame(downreg_trametinib_significant_exp,downreg_erk12_significant_exp, downreg_sherk_significant_exp))
downregulated_all_exp

#updown
updown = scale(distinct(rbind.data.frame(upregulated_all_exp,downregulated_all_exp)))

##Elbow method
fviz_nbclust(updown, kmeans, method = "wss") +
geom_vline(xintercept = 4, linetype = 2)+
labs(subtitle = "Elbow method")
##Silhouette method
fviz_nbclust(updown, kmeans, method = "silhouette")+
labs(subtitle = "Silhouette method")
##Gap statistic
set.seed(123)
fviz_nbclust(updown, kmeans, nstart = 25, method = "gap_stat", nboot = 50)+
labs(subtitle = "Gap statistic method")
nb = NbClust(updown, distance = "euclidean", min.nc = 2,
max.nc = 10, method = "kmeans")
fviz_nbclust(nb)
km.updown = eclust(updown, "kmeans", k = 4, nstart = 25, graph = FALSE)
#Visualize k-means clusters
fviz_cluster(km.updown, geom = "point", ellipse.type = "convex",
palette = "jco", ggtheme = theme_minimal())
#Hierarchical clustering
hc.updown = eclust(updown, "hclust", k = 4, hc_metric = "euclidean", hc_method = "ward.D2", graph = FALSE)
fviz_dend(hc.updown, show_labels = FALSE,
palette = "jco", as.ggplot = TRUE)
#Cluster validation: silhouette plot
fviz_silhouette(km.updown, palette = "jco",
ggtheme = theme_classic())
silinfo = km.res$silinfo
names(silinfo)
head(silinfo$widths[, 1:3], 10)
silinfo$clus.avg.widths
silinfo$avg.width

#with names
fviz_cluster(km.updown, data = updown)
```



#Principal component analysis

```{r}
#Centering and scaling, pick data only from final time and only genes with highest variance
pca_dataframe = scale(data.skin.cancer.human_skin_TRA)
pca_dataframe = t(pca_dataframe[,c(4:5, 10:15)])

topVar = apply(pca_dataframe, 2, var)
q75 = quantile(topVar, probs = 0.75)
i.topvar = which(topVar >= q75)
pca_dataframe_topVar = pca_dataframe[,i.topvar]

#PCA
skin_pca_topVar = prcomp(pca_dataframe_topVar, scale. = F, center = F)
print(skin_pca_topVar)

#Biplot of first 2 principal components (very ugly bcos too many genes, dont use this plot)
biplot(skin_pca_topVar)

#Proportion of variance of each principal component
variance = (skin_pca_topVar$sdev)^2
prop.variance = variance/sum(variance)
names(prop.variance) = 1:length(prop.variance)
barplot(prop.variance, ylab='Proportion of variance', xlab = "Principal components", main = "Proportion of variance of each principal component")

#Barplots of principal components
par(las = 2)
barplot(skin_pca_topVar$rotation[,1], main = "PC1", ylab = "Contribution", xlab = "Genes")
barplot(skin_pca_topVar$rotation[,2], main = "PC2", ylab = "Contribution", xlab = "Genes")

#Genes with most contribution to PC1 and PC2
top_genes_pca1 = names(sort(abs(skin_pca_topVar$rotation[,1]), decreasing = T)[1:5])
top_genes_pca2 = names(sort(abs(skin_pca_topVar$rotation[,2]), decreasing = T)[1:5])

#Scatterplot of data with PC1 and PC2 as new coordinates
plot(skin_pca_topVar$x[,1], skin_pca_topVar$x[,2], 
     col= c("red", "red", "green", "green", "green", "blue", "blue", "blue"), pch=19,
     xlab='PC1', ylab='PC2', main = "PC1 and PC2 as new coordinates")
legend("topright",c("Sherk", "ERK1/2 inhibitor", "Trametinib"),col=c("red", "green", "blue"), pch = 15, bg = "yellow")
```


#Limma Analysis

```{r}
## First group: We compare the expression values from day 3 to day 7 with the shERK1
design = model.matrix(~ 0+factor(c(2,2,2,1,1)))
design
colnames(design) = c("Sherk7D", "Sherk3D")
fit = lmFit(data.skin.cancer.human_skin_TRA[,1:5], design) #fit linear model
fit
contrast.matrix = makeContrasts(Sherk7D-Sherk3D, levels=design)
fit2 = contrasts.fit(fit, contrast.matrix)
fit2 =  eBayes(fit2, 0.01)


T1 = topTable(fit2,adjust.method = "fdr", sort.by = "logFC")
lola1=T1[which(T1$logFC>0),]
lola1 = lola1[1:10,]



## Second group: We compare 3h ERK1/2 and 24h ERK1/2

data_ERK = data.skin.cancer.human_skin_TRA[,c(10:12, 6,7)]

design_ERK = model.matrix(~ 0+factor(c(1,1,1,2,2)))
design_ERK
colnames(design_ERK) = c("ERK12_inh_24h", "ERK12_inh_3h")
fit_ERK = lmFit(data_ERK, design_ERK) #fit linear model
fit_ERK
contrast.matrix_ERK = makeContrasts(ERK12_inh_24h-ERK12_inh_3h, levels=design_ERK)
fit2_ERK = contrasts.fit(fit_ERK, contrast.matrix_ERK)
fit2_ERK =  eBayes(fit2_ERK, 0.01)


T2 = topTable(fit2_ERK,adjust.method = "fdr", sort.by = "logFC", number = 130) 
lola2 = T2[which(T2$logFC>0),]
lola2 = lola2[1:10,]


## Third group: We compare 3h to 24h Trametinib
data_Trametinib = data.skin.cancer.human_skin_TRA[,c(13:15, 8,9)]

design_Trametinib = model.matrix(~ 0+factor(c(1,1,1,2,2)))
design_Trametinib
colnames(design_Trametinib) = c("Trametinib_24h", "Trametinib_3h")
fit_Trametinib = lmFit(data_Trametinib, design_Trametinib) #fit linear model
fit_Trametinib
contrast.matrix_Trametinib = makeContrasts(Trametinib_24h-Trametinib_3h, levels=design_Trametinib)
fit2_Trametinib= contrasts.fit(fit_Trametinib, contrast.matrix_Trametinib)
fit2_Trametinib =  eBayes(fit2_Trametinib, 0.01)


T3 = topTable(fit2_Trametinib,adjust.method = "fdr", sort.by = "logFC", number = Inf ) 
lola3 = T3[which(T3$logFC>0),]
lola3 = lola3[1:10,]
```





#Regression model

```{r}
#Linear regression model (Predict drug target genes with identified genes)

summary(lm(MPZL3 ~ GJA1, data = data.frame(t(data.skin.cancer.human_skin_TRA))))

#F-test



```


```{r}

```


```{r}

```

## Unused code
# Highly upregulated Genes

```{r}
#Making the baseline
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("Meta")
library(GEOquery)
install.packages("ellipsis")

gds <- getGEO("GSE162973", GSEMatrix = FALSE)

gdslist = GSMList(gds)
Table(gdslist[[1]])[1:5,]
probesets = Table(GPLList(gds)[[1]])$ID

data.matrix = do.call('cbind',lapply(gdslist,function(x) 
                                      {tab <- Table(x)
                                       both_match <- match(probesets,tab$ID_REF)
                                       return(tab$VALUE[both_match])
                                     }))
data.matrix <- apply(data.matrix,2,function(x) {as.numeric(as.character(x))})
data.matrix <- log2(data.matrix)
data.matrix[1:5,]


require(Biobase)
rownames(data.matrix) <- probesets
colnames(data.matrix) <- names(gdslist)
pdata <- data.frame(samples=names(gdslist))
rownames(pdata) <- names(gdslist)
pheno <- as(pdata,"AnnotatedDataFrame")
eset2 <- new('ExpressionSet',exprs=data.matrix,phenoData=pheno)



#From here on it's my own code
##Making expression matrix for control
control_exprs = exprs(eset2)[,1:3]

##Renaming the control matrix with genes
control.gene = Table(GPLList(gds)[[1]])$ILMN_Gene
names(control.gene) = probesets
control_chip_ID = rownames(control_exprs)
new_control_chip_ID = control_chip_ID[control_chip_ID %in% probesets]

control_exprs = control_exprs[new_control_chip_ID,]
control_gene_names = control.gene[new_control_chip_ID]
rownames(control_exprs) = as.character(control_gene_names)

##Removing genes with no names
all.spaces.control_exprs = sapply(rownames(control_exprs),function(x){which(x=="")})
dim(control_exprs)
#48107 3

length(which(rownames(control_exprs) == ""))
#784

control_exprs = control_exprs[-which(all.spaces.control_exprs>0),]
#47323 3

##Replacing gene expressions with no data (code needs improvement with loop)
na = which(is.na(control_exprs[,2]))
for (x in na) {
  control_exprs[x,2] = mean(control_exprs[x,c(1,3)])
}

na = which(is.na(control_exprs[,3]))
for (x in na) {
  control_exprs[x,3] = mean(control_exprs[x,c(1,2)])
}

head(control_exprs)
```

# fold change
```{r}
#Finding upregulated (from 3rd to 7th day) human skin genes for treatment with Sherk1
upreg_sherk1 = c()
for (i in 1:length(rownames(data.skin.cancer.human_skin_TRA))) {
  if((mean(data.skin.cancer.human_skin_TRA[i,1:3]) <      mean(data.skin.cancer.human_skin_TRA[i,4:5])) == TRUE)
    upreg_sherk1 = c(upreg_sherk1, rownames(data.skin.cancer.human_skin_TRA)[i])
}
upreg_sherk1

#Finding highly upregulated (3rd to 7th day) human skin genes for treatment with Sherk1
upreg_sherk1 = c()
for (i in 1:length(rownames(data.skin.cancer.human_skin_TRA))) {
  if(((mean(data.skin.cancer.human_skin_TRA[i,4:5]) -      mean(data.skin.cancer.human_skin_TRA[i,1:3])) >= 1.13) == TRUE)
    upreg_sherk1 = c(upreg_sherk1, rownames(data.skin.cancer.human_skin_TRA)[i])
}
upreg_sherk1


#Finding upregulated (from 3rd to 24th hour) human skin genes for treatment with ERK inhibitor
upreg_erk12_inh = c()
for (i in 1:length(rownames(data.skin.cancer.human_skin_TRA))) {
  if((mean(data.skin.cancer.human_skin_TRA[i,6:7]) <      mean(data.skin.cancer.human_skin_TRA[i,10:12])) == TRUE)
    upreg_erk12_inh = c(upreg_erk12_inh, rownames(data.skin.cancer.human_skin_TRA)[i])
}
upreg_erk12_inh

#Finding highly upregulated (3rd to 24th hour) human skin genes for treatment with ERK inhibitor
upreg_erk12_inh = c()
for (i in 1:length(rownames(data.skin.cancer.human_skin_TRA))) {
  if(((mean(data.skin.cancer.human_skin_TRA[i,10:12]) -      mean(data.skin.cancer.human_skin_TRA[i,6:7])) >= 1.18) == TRUE)
    upreg_erk12_inh = c(upreg_erk12_inh, rownames(data.skin.cancer.human_skin_TRA)[i])
}
upreg_erk12_inh


#Finding upregulated (from 3rd to 24th hour) human skin genes for treatment with trametinib
upreg_trametinib = c()
for (i in 1:length(rownames(data.skin.cancer.human_skin_TRA))) {
  if((mean(data.skin.cancer.human_skin_TRA[i,8:9]) <      mean(data.skin.cancer.human_skin_TRA[i,13:15])) == TRUE)
    upreg_trametinib = c(upreg_trametinib, rownames(data.skin.cancer.human_skin_TRA)[i])
}
upreg_trametinib

#Finding highly upregulated (3rd to 24th hour) human skin genes for treatment with trametinib
upreg_trametinib = c()
for (i in 1:length(rownames(data.skin.cancer.human_skin_TRA))) {
  if(((mean(data.skin.cancer.human_skin_TRA[i,13:15]) -      mean(data.skin.cancer.human_skin_TRA[i,8:9])) >= 1.16) == TRUE)
    upreg_trametinib = c(upreg_trametinib, rownames(data.skin.cancer.human_skin_TRA)[i])
}
upreg_trametinib




#Log change
##Sherk1
logchange_sherk1 = c()
for (i in 1:length(rownames(data.skin.cancer.human_skin_TRA))) {
  logchange_sherk1 = c(logchange_sherk1, mean(data.skin.cancer.human_skin_TRA[i,4:5]) -      mean(data.skin.cancer.human_skin_TRA[i,1:3]))
}
logchange_sherk1

##Erk12 Inhibitor
logchange_erk12_inh = c()
for (i in 1:length(rownames(data.skin.cancer.human_skin_TRA))) {
  logchange_erk12_inh = c(logchange_erk12_inh, mean(data.skin.cancer.human_skin_TRA[i,10:12]) -      mean(data.skin.cancer.human_skin_TRA[i,6:7]))
}
logchange_erk12_inh

##Trametinib
logchange_trametinib = c()
for (i in 1:length(rownames(data.skin.cancer.human_skin_TRA))) {
  logchange_trametinib = c(logchange_trametinib, mean(data.skin.cancer.human_skin_TRA[i,13:15]) -      mean(data.skin.cancer.human_skin_TRA[i,8:9]))
}
logchange_trametinib


# Compile all logFC into a table
logchange_table = cbind(logchange_sherk1, logchange_erk12_inh, logchange_trametinib)
colnames(logchange_table) = c("Sherk1", "ERK1/2 Inhibitor", "Trametinib")
rownames(logchange_table) = rownames(data.skin.cancer.human_skin_TRA)
head(logchange_table)

#Log change for highly expressed genes
##Combine all highly expressed genes in a vector
highexpgenes = unique(c(upreg_sherk1, upreg_erk12_inh, upreg_trametinib))

##Make new table from previous table
logchange_highexp = logchange_table[highexpgenes,]
logchange_highexp
```

#Different drugs, different times
```{r}
#however i did try what Maria showed in github for different times, and different drugs:

# boxplots of high expressions with different hours 
three.hours = data.skin.cancer.human_skin_TRA[,6:9]
twentyfour.hours = data.skin.cancer.human_skin_TRA[,10:15]
three.days = data.skin.cancer.human_skin_TRA[,1:3]
seven.days = data.skin.cancer.human_skin_TRA[,4:5]

data.fortime=rbind(highest,highest,highest,highest)
data.fortime[c(1:4),c(4:15)]=NA
data.fortime[c(5:8),c(1:3,6:15)]=NA
data.fortime[c(9:12),c(1:5,10:15)]=NA
data.fortime[c(13:16),c(1:9)]=NA

a.order.vector=sort(colnames(t(data.fortime)),index.return=T)$ix
boxplot(t(data.fortime)[,a.order.vector],cex.axis=0.6,col=c("pink","red","yellow", "purple"),main="skin specific TRA expression in skin cancer",ylab="log2(gene expression)")
abline(h=c(6:12),col="grey",lty=3)
legend("topright",c("3h","24h","3d", "7d"),col=c("pink","red","yellow", "purple"),pch=15,bg="white")

# boxplots of highly expressed genes under different drugs (binnur)
sherk1 <- data[,1:5]
ERK12inh <- c(data[,6:7], data[10:12])
trametinib <- c(data[8:9], data[13:15])

data.fordrug=rbind(highest,highest,highest)
data.fordrug[c(1:5),c(ERK12inh, trametinib)]=NA
data.fordrug[c(6:7, 10:12),c(sherk1,trametinib)]=NA
data.fordrug[c(8:9, 13:15),c(sherk1, ERK12inh)]=NA

order.vector=sort(colnames(t(data.fordrug)),index.return=T)$ix
boxplot(t(data.fordrug)[,order.vector],cex.axis=0.6,col=c("pink","red", "purple"),main="diff drugs",ylab="log2(gene expression)")
abline(h=c(6:12),col="grey",lty=3)
legend("topright",c("sherk1","ERK12inh","trametinib"),col=c("pink","red","purple"),pch=15,bg="white")

# ERK12inh vs sherk1 drug efficacy
# look into same drug same time chips separately to find out which genes' expression went high the most -> upregulated
# compare the upregulated ones with breast cancer upregulated ones
# cluster to confirm upregulated genes (see if they are together?)


# Boxplots of highly expressed genes with different drugs (richard)
k = c()
for(i in 1:15){
  k = c(k, rownames(data[which(data[,i]>13),]))
}

highly_expressed = unique(k)
variable_expressed = highly_expressed[c(1:5)]

mostvariable = data[variable_expressed,]
a.data.new=rbind(mostvariable,mostvariable,mostvariable,mostvariable,mostvariable,mostvariable)
a.data.new[c(1:5), c(4:15)]=NA
a.data.new[c(6:10), c(1:3, 6:15)]=NA
a.data.new[c(11:15), c(1:5, 8:15)]=NA
a.data.new[c(16:20), c(1:9, 13:15)]=NA
a.data.new[c(21:25), c(1:7, 10:15)]=NA
a.data.new[c(26:30), c(1:12)]=NA

a.order.vector=sort(colnames(t(a.data.new)),index.return=T)$ix
boxplot(t(a.data.new)[,a.order.vector],cex.axis=0.6,col=c("pink","red", "green","yellow","blue","purple"),main="diff drugs",ylab="log2(gene expression)", las =2)
abline(h=c(6:12),col="grey",lty=3)
legend("bottomleft",c("sherk1 after 3 days", "sherk1 after 7 days", "ERK12inh after 3h", "ERK12inh after 24h", "trametinib after 3h", "trametinib after 24h"),col=c("pink","red", "green","yellow","blue","purple"),pch=15,bg="white")


#Same as before, but only for chip 1
highest <- data[which(data[,1]>13.5),]
a.data.new=rbind(highest,highest,highest,highest,highest,highest)
a.data.new[c(1:4), c(4:15)]=NA
a.data.new[c(5:8), c(1:3, 6:15)]=NA
a.data.new[c(9:12), c(1:5, 8:15)]=NA
a.data.new[c(13:16), c(1:9, 13:15)]=NA
a.data.new[c(17:20), c(1:7, 10:15)]=NA
a.data.new[c(21:24), c(1:12)]=NA

a.order.vector=sort(colnames(t(a.data.new)),index.return=T)$ix
boxplot(t(a.data.new)[,a.order.vector],cex.axis=0.6,col=c("pink","red", "green","yellow","blue","purple"),main="diff drugs",ylab="log2(gene expression)", las = 2)
abline(h=c(6:12),col="grey",lty=3)
legend("bottomleft",c("sherk1 after 3 days", "sherk1 after 7 days", "ERK12inh after 3h", "ERK12inh after 24h", "trametinib after 3h", "trametinib after 24h"),col=c("pink","red", "green","yellow","blue","purple"),pch=15,bg="white")
```


